general:
  branches:
    only:
      - stage
      - hotfix-circleci

machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    # docker-compose v1.2.0
    - curl -L https://github.com/docker/compose/releases/download/1.2.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
    - chmod +x ~/docker-compose
    - mkdir -p ~/docker
    # dockerenv-apache php53
    - if [[ ! -e ~/docker/dockerenv_apache.tar ]]; then docker pull "avatarnewyork/dockerenv-apache:php53" && docker save "avatarnewyork/dockerenv-apache:php53" > ~/docker/dockerenv_apache.tar; else docker load -i ~/docker/dockerenv_apache.tar; fi
    # dockerenv-mysql mysql55
    - if [[ ! -e ~/docker/dockerenv_mysql.tar ]]; then docker pull "avatarnewyork/dockerenv-mysql" && docker save "avatarnewyork/dockerenv-mysql" > ~/docker/dockerenv_mysql.tar; else docker load -i ~/docker/dockerenv_mysql.tar; fi
    # drupal data / config
    - cp ~/$CIRCLE_PROJECT_REPONAME/tests/config/settings.database.php ~/$CIRCLE_PROJECT_REPONAME/public/sites/default/
    # replace env vars for docker-compose.yml
    - ./bin/docker-compose-helper.sh

test:
  post:
    # docker up
    - ~/docker-compose -f ~/$CIRCLE_PROJECT_REPONAME/tests/config/docker-compose.yml up -d
    # import db (sleep needed)
    - sleep 40; zcat ~/$CIRCLE_PROJECT_REPONAME/tests/data/db.sql.gz | mysql -uadmin --password='admin' -P3366 -h127.0.0.1 test
    # ngrock tunnel
    - wget https://dl.ngrok.com/ngrok_2.0.17_linux_amd64.zip
    - unzip ngrok_2.0.17_linux_amd64.zip
    - ./ngrok authtoken $NGROK_TOKEN
    - ./ngrok http -subdomain=$CIRCLE_SHA1 8080:
        background: true
    # Wait for application and ngrok to be ready
    - curl --retry 10 --retry-delay 10 -v https://$CIRCLE_SHA1.ngrok.io
    # Execute Ghost Inspector tests using the ngrok tunnel
    - curl "https://api.ghostinspector.com/v1/suites/$GHOST_SUITE_ID/execute/?apiKey=$GHOST_API_KEY&startUrl=https://$CIRCLE_SHA1.ngrok.io" > $CIRCLE_ARTIFACTS/ghostinspector.json
    - if [ $(grep -c '"passing":false' $CIRCLE_ARTIFACTS/ghostinspector.json) -ne 0 ]; then exit 1; fi

deployment:
  staging:
    branch:
      - stage
    commands:
      - ./bin/deploy.sh
